name: Build Cromite
permissions:
  actions: write
  checks: none
  contents: read
  deployments: none
  issues: none
  packages: none
  pull-requests: none
  repository-projects: none
  security-events: none
  statuses: none

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled'
        required: false
        default: false
      sha:
        description: 'uazo/cromite SHA (defaults to current commit)'
        required: false
        default: ''
      target_os:
        description: 'targetos [android]'
        required: true
        default: 'android'
      build:
        description: 'android arch [arm64]'
        required: true
        default: 'arm64'
      type:
        description: 'runner label'
        required: true
        default: 'depot-ubuntu-24.04-16'
      debug:
        description: 'debug? [true/false]'
        required: true
        default: 'false'

env:
  CROMITE_SHA: ${{ github.event.inputs.sha || github.sha }}
  REMOVEDOCKERSUPPORT: true
  USELOCALIMAGE: true

jobs:
  build_all:
    runs-on: ${{ github.event.inputs.type }}
    timeout-minutes: 1440
    steps:
      # Enable tmate debugging of manually-triggered workflows if the input option was provided
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        with:
          detached: true

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: cromite
          ref: ${{ env.CROMITE_SHA }}
          fetch-depth: 1

      - name: Download regctl
        shell: bash
        run: |
          curl -L https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 >regctl
          chmod 755 regctl

      - name: Get current chromium version
        shell: bash
        run: |
          export VERSION=$( cat ./cromite/build/RELEASE )
          echo "Current version is $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          cd cromite/tools

      - name: Building build-deps container ${{ env.VERSION }}
        shell: bash
        run: |
          docker pull uazo/build-deps:$VERSION || true
          IS_PRESENT=$(docker inspect --type=image uazo/build-deps:$VERSION > /dev/null ; echo $?)
          if [ $IS_PRESENT -ne "0" ]; then
            IS_PRESENT=$(./regctl image inspect uazo/build-deps:$VERSION > /dev/null ; echo $?)
            if [ $IS_PRESENT -ne "0" ]; then
              DOCKER_BUILDKIT=1 docker build -t uazo/build-deps:$VERSION \
                --progress plain \
                --build-arg VERSION=$VERSION \
                --no-cache \
                cromite/tools/images/build-deps/.
            fi
          fi

      - name: Building chromium container ${{ env.VERSION }}
        shell: bash
        run: |
          docker pull uazo/chromium:$VERSION || true
          IS_PRESENT=$(docker inspect --type=image uazo/chromium:$VERSION > /dev/null ; echo $?)
          if [ $IS_PRESENT -ne "0" ]; then
            IS_PRESENT=$(./regctl image inspect uazo/chromium:$VERSION > /dev/null ; echo $?)
            if [ $IS_PRESENT -ne "0" ]; then
              DOCKER_BUILDKIT=1 docker build -t uazo/chromium:$VERSION \
                --progress plain \
                --build-arg VERSION=$VERSION \
                cromite/tools/images/chr-source/.
            fi
          fi

      - name: Building cromite container ${{ env.VERSION }}-${{ env.CROMITE_SHA }}
        shell: bash
        run: |
          docker pull uazo/cromite:$VERSION-$CROMITE_SHA || true
          IS_PRESENT=$(docker inspect --type=image uazo/cromite:$VERSION-$CROMITE_SHA > /dev/null ; echo $?)
          if [ $IS_PRESENT -ne "0" ]; then
            IS_PRESENT=$(./regctl image inspect uazo/cromite:$VERSION-$CROMITE_SHA > /dev/null ; echo $?)
            if [ $IS_PRESENT -ne "0" ]; then
              DOCKER_BUILDKIT=1 docker build -t uazo/cromite:$VERSION-$CROMITE_SHA --progress plain \
                --build-arg CROMITE_SHA=$CROMITE_SHA \
                --build-arg VERSION=$VERSION \
                -f cromite/tools/images/cromite-source/Dockerfile \
                cromite/
            fi
          fi

      - name: Building cromite-build container ${{ env.VERSION }}-${{ env.CROMITE_SHA }}
        shell: bash
        run: |
          docker pull uazo/cromite-build:$VERSION-$CROMITE_SHA || true
          IS_PRESENT=$(docker inspect --type=image uazo/cromite-build:$VERSION-$CROMITE_SHA > /dev/null ; echo $?)
          if [ $IS_PRESENT -ne "0" ]; then
            IS_PRESENT=$(./regctl image inspect uazo/cromite-build:$VERSION-$CROMITE_SHA > /dev/null ; echo $?)
            if [ $IS_PRESENT -ne "0" ]; then
              DOCKER_BUILDKIT=1 docker build -t uazo/cromite-build:$VERSION-$CROMITE_SHA --progress plain \
                --build-arg CROMITE_SHA=$CROMITE_SHA \
                --build-arg VERSION=$VERSION \
                --no-cache \
                cromite/tools/images/cromite-build/.
            fi
          fi

      - name: Mark image to build
        shell: bash
        run: |
          IS_PRESENT=$(docker inspect --type=image uazo/cromite-build:build > /dev/null ; echo $?)
          if [ $IS_PRESENT -eq "0" ]; then
            docker rmi uazo/cromite-build:build
          fi
          docker tag uazo/cromite-build:$VERSION-$CROMITE_SHA uazo/cromite-build:build

      - name: Prepare Keystore
        shell: bash
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > cromite.keystore
            echo "Keystore decoded."
          else
             echo "Warning: KEYSTORE_BASE64 secret not found."
             touch cromite.keystore
          fi

      - name: Run Build in Container
        shell: bash
        run: |
          # Create a build script to run inside the container
          cat <<'EOF' > build_script.sh
          #!/bin/bash
          set -e
          
          export WORKSPACE=/home/lg/working_dir
          export HOME=/home/lg/working_dir
          
          # Workspace is /home/lg/working_dir
          export PATH=$WORKSPACE/chromium/src/third_party/llvm-build/Release+Asserts/bin:$WORKSPACE/depot_tools/:/usr/local/go/bin:$WORKSPACE/mtool/bin:$PATH
          
          # Setup permissions (ensure user lg owns the workspace which is already set in dockerfile, but double check)
          # Note: sudo inside container requires passwordless sudo which seems to be the case for user lg
          
          cd $WORKSPACE/chromium/src
          
          echo "Generating build files..."
          gn gen --args="target_os = \"android\" $(cat /home/lg/working_dir/cromite/build/cromite.gn_args) target_cpu = \"arm64\" " out/arm64
          
          echo "Compiling..."
          vpython3 /home/lg/working_dir/depot_tools/siso.py ninja -C out/arm64 chrome_public_bundle --offline
          vpython3 /home/lg/working_dir/depot_tools/siso.py ninja -C out/arm64 chrome_public_apk --offline
          
          EOF
          
          chmod +x build_script.sh

          # Run the container
          docker run --name cromite-builder \
            -v $(pwd)/cromite.keystore:/home/lg/working_dir/cromite.keystore \
            -v $(pwd)/build_script.sh:/home/lg/working_dir/build_script.sh \
            -e TARGET_OS=android \
            -e TARGET_ISDEBUG=${{ github.event.inputs.debug }} \
            -e USE_KEYSTORE=true \
            -e KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }} \
            -e CROMITE_PREF_HASH_SEED_BIN=${{ secrets.CROMITE_PREF_HASH_SEED_BIN }} \
            uazo/cromite-build:build \
            bash -c "/home/lg/working_dir/build_script.sh"

      - name: Copy Artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          docker cp cromite-builder:/home/lg/working_dir/chromium/src/out/arm64/apks/ChromePublic.apk artifacts/ChromePublic.apk || echo "Failed to copy APK"
          
          # Cleanup
          docker rm cromite-builder

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Cromite-Android-arm64
          path: artifacts/ChromePublic.apk

